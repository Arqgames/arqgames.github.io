<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />

    <!-- ç”»é¢è¡¨ç¤ºï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- åŸºæœ¬SEO -->
    <title>Bible Timeline Quiz</title>
    <meta name="description"
        content="Bible Timeline Quiz is a free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />

    <!-- æ¤œç´¢çµæœã®è¡¨ç¤ºå¼·åŒ–ï¼ˆOpen Graph / Twitterï¼‰ -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Bible Timeline Quiz" />
    <meta property="og:description"
        content="A free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />
    <!-- TODO: å…¬é–‹URLãŒç¢ºå®šã—ãŸã‚‰ã“ã“ã‚’æ›¸ãæ›ãˆï¼ˆGitHub Pagesã®URLï¼‰ -->
    <!-- ä¾‹: https://btlq.github.io/ -->
    <meta property="og:url" content="https://arqgames.github.io/btlq/" />

    <!-- TODO: ã‚µãƒ ãƒç”»åƒã‚’ç½®ãå ´åˆï¼ˆ/og.png ãªã©ï¼‰ -->
    <!-- <meta property="og:image" content="https://arqgames.github.io/.png" /> -->

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Bible Timeline Quiz" />
    <meta name="twitter:description"
        content="A free browser game where you arrange Bible events in chronological order. Supports Japanese and English." />

    <!-- è¡¨ç¤ºã®é›°å›²æ°—ï¼ˆä»»æ„ï¼‰ -->
    <meta name="theme-color" content="#f4e4bc" />

    <!-- ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä»»æ„ï¼šå¾Œã§è¿½åŠ ã—ã¦OKï¼‰ -->
    <!-- <link rel="icon" href="/favicon.ico" /> -->
    <!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png" /> -->

    <!-- ãƒ•ã‚©ãƒ³ãƒˆ / ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã‚ãªãŸã®ç¾çŠ¶ã‚’ç¶­æŒï¼‰ -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8810957223833437"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="/css/ui.css">

</head>

<body>

    <div class="container">
        <button class="top-btn home-btn" type="button" id="homeBtn" title="Home">
            <svg width="22" height="22" viewBox="0 0 24 24" style="display:block;">
                <path d="M12 3.2 3 10.3V21a1 1 0 0 0 1 1h5v-7h6v7h5a1 1 0 0 0 1-1V10.3l-9-7.1z" fill="currentColor" />
            </svg>
        </button>

        <button class="top-btn lang-switch" type="button" id="langBtn" title="Language">EN</button>

        <div id="screen-setup">
            <div class="header-icon-box"><span class="material-icons header-icon">menu_book</span></div>
            <h1 data-ja="è–æ›¸å¹´è¡¨ã‚¯ã‚¤ã‚º" data-en="Bible Timeline Quiz">è–æ›¸å¹´è¡¨ã‚¯ã‚¤ã‚º</h1>

            <div class="quick-btn-container">
                <button class="q-btn full" onclick="quickSet(-4026, 98, this)" data-ja="å…¨æœŸé–“"
                    data-en="All Periods">å…¨æœŸé–“</button>

                <button class="q-btn" onclick="quickSet(-4026, -1513, this)" data-ja="å‰µä¸–è¨˜ã€œæ—é•·æ™‚ä»£"
                    data-en="Genesis & Patriarchs">å‰µä¸–è¨˜ã€œæ—é•·æ™‚ä»£</button>

                <button class="q-btn" onclick="quickSet(-1513, -1070, this)" data-ja="ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«å¾æœ"
                    data-en="Conquest">ã‚¤ã‚¹ãƒ©ã‚¨ãƒ«å¾æœ</button>

                <button class="q-btn" onclick="quickSet(-1070, -2, this)" data-ja="ç‹å›½ã®è¡°é€€ãƒ»å†å»º"
                    data-en="Kings, Exile & Return">ç‹å›½ã®è¡°é€€ãƒ»å†å»º</button>

                <button class="q-btn" onclick="quickSet(-2, 98, this)" data-ja="ã‚­ãƒªã‚¹ãƒˆãƒ»ä½¿å¾’"
                    data-en="Jesus & Apostles">ã‚­ãƒªã‚¹ãƒˆãƒ»ä½¿å¾’</button>
            </div>

            <div class="picker-group">
                <div class="picker-column"><span style="font-size:0.75em; font-weight:bold;" data-ja="é–‹å§‹"
                        data-en="Start">é–‹å§‹</span><select id="select-start"></select></div>
                <div class="picker-column"><span style="font-size:0.75em; font-weight:bold;" data-ja="çµ‚äº†"
                        data-en="End">çµ‚äº†</span><select id="select-end"></select></div>
            </div>

            <select id="count-select" style="width:100%; margin-top:15px;">
                <option value="3" data-ja="3å• ã€åˆç´šã€‘" data-en="3 Events [Easy]">3å• ã€åˆç´šã€‘</option>
                <option value="5" selected data-ja="5å• ã€ãƒãƒ¼ãƒãƒ«ã€‘" data-en="5 Events [Normal]">5å• ã€ãƒãƒ¼ãƒãƒ«ã€‘</option>
                <option value="8" data-ja="8å• ã€ãƒãƒ¼ãƒ‰ã€‘" data-en="8 Events [Hard]">8å• ã€ãƒãƒ¼ãƒ‰ã€‘</option>
                <option value="12" data-ja="12å• ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã€‘" data-en="12 Events [Legend]">12å• ã€ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã€‘</option>
                <option value="20" data-ja="20å• ã€ã‚´ãƒƒãƒ‰ã€‘" data-en="20 Events [God Mode]">20å• ã€ã‚´ãƒƒãƒ‰ã€‘</option>
            </select>
            <select id="time-attack-select" style="width:100%; margin-top:10px;">
                <option value="off" data-ja="ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šOFF" data-en="Time Attack: OFF">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šOFF</option>
                <option value="on" data-ja="ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šON" data-en="Time Attack: ON">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ï¼šON</option>
            </select>
            <div id="error-msg"></div>
            <button class="btn" onclick="startGame()" data-ja="å†’é™ºã‚’é–‹å§‹" data-en="Start Adventure">å†’é™ºã‚’é–‹å§‹</button>
        </div>

        <div id="screen-game" class="hidden">
            <div id="timer-display" style="font-size: 1.5em; font-weight: bold; color: #d63031; margin-bottom: 10px;">
                â± <span id="time-left">00</span>s
            </div>
            <div id="event-list"></div>
            <div id="hint-area" class="hidden"></div>
            <button class="btn" onclick="checkOrder()" data-ja="ç­”ãˆåˆã‚ã›" data-en="Check Answer">ç­”ãˆåˆã‚ã›</button>
        </div>

        <div id="screen-result" class="hidden">
            <div class="header-icon-box"><span class="material-icons header-icon" id="result-icon">star</span></div>
            <h2 id="result-title"></h2>
            <div id="fail-options" class="hidden">
                <button class="btn" onclick="showHint()" data-ja="ãƒ’ãƒ³ãƒˆ" data-en="Hint">ãƒ’ãƒ³ãƒˆ</button>
                <button class="btn btn-sub" onclick="retryThisTask()" data-ja="å†æŒ‘æˆ¦" data-en="Retry">å†æŒ‘æˆ¦</button>
            </div>
            <div id="success-options" class="hidden"><button class="btn" onclick="location.reload()" data-ja="æ¬¡ã¸"
                    data-en="Next">æ¬¡ã¸</button></div>
        </div>
    </div>

    <script>
        let currentLang = 'ja';
        let currentTask = [];
        let timerInterval;
        let timeLeft;
        /* çµæœç”»é¢ã®å†æç”»ç”¨ï¼šç›´å‰ã®å‹æ•—ã‚’è¦šãˆã‚‹ */
        let lastIsWin = null;
        /* ãƒ’ãƒ³ãƒˆå†æç”»ç”¨ï¼šç›´å‰ã«è¡¨ç¤ºã—ãŸãƒ’ãƒ³ãƒˆã®IDã‚’è¦šãˆã‚‹ */
        let lastHintIds = null;
        let lastHintWasEmpty = null;

        const refMap = {
            "Gen": "å‰µ", "Exo": "å‡º", "Lev": "ãƒ¬ãƒ“", "Num": "æ°‘", "Deut": "ç”³",
            "Josh": "ãƒ¨ã‚·ãƒ¥", "Judg": "è£", "Ruth": "ãƒ«ãƒ„", "1Sam": "ã‚µãƒ ä¸€", "2Sam": "ã‚µãƒ äºŒ",
            "1Ki": "ç‹ä¸€", "2Ki": "ç‹äºŒ", "1Chr": "ä»£ä¸€", "2Chr": "ä»£äºŒ", "Ezra": "ã‚¨ã‚ºãƒ©",
            "Neh": "ãƒãƒ˜", "Esth": "ã‚¨ã‚¹", "Job": "ãƒ¨ãƒ–", "Ps": "è©©", "Prov": "ç®´",
            "Isa": "ã‚¤ã‚¶", "Jer": "ã‚¨ãƒ¬", "Lam": "å“€", "Ezek": "ã‚¨ã‚¼", "Dan": "ãƒ€ãƒ‹",
            "Amos": "ã‚¢ãƒ¢", "Jonah": "ãƒ¨ãƒŠ", "Mic": "ãƒŸã‚«", "Hab": "ãƒãƒ", "Mal": "ãƒãƒ©",
            "Matt": "ãƒã‚¿", "Mark": "ãƒãƒ«", "Luke": "ãƒ«ã‚«", "John": "ãƒ¨ãƒ", "Acts": "ä½¿å¾’",
            "Rom": "ãƒ­ãƒ", "1Cor": "ã‚³ãƒªä¸€", "2Cor": "ã‚³ãƒªäºŒ", "Gal": "ã‚¬ãƒ©", "Eph": "ã‚¨ãƒ•ã‚§",
            "Phil": "ãƒ•ã‚£ãƒª", "Col": "ã‚³ãƒ­", "1Thess": "ãƒ†ã‚µä¸€", "2Thess": "ãƒ†ã‚µäºŒ", "1Tim": "ãƒ†ãƒ¢ä¸€",
            "2Tim": "ãƒ†ãƒ¢äºŒ", "Titus": "ãƒ†ãƒˆ", "Philem": "ãƒ•ã‚£ãƒ¬", "Heb": "ãƒ˜ãƒ–", "Jas": "ãƒ¤ã‚³",
            "1Pet": "ãƒšãƒ†ä¸€", "2Pet": "ãƒšãƒ†äºŒ", "1John": "ãƒ¨ãƒä¸€", "2John": "ãƒ¨ãƒäºŒ", "3John": "ãƒ¨ãƒä¸‰",
            "Jude": "ãƒ¦ãƒ€", "Rev": "å•“"
        };

        function formatRef(ref) {
            if (currentLang === 'en') return ref;
            let parts = ref.split(' ');
            let bookEn = parts[0];
            let verse = parts[1] || "";
            return verse
                ? (refMap[bookEn] || bookEn) + " " + verse
                : (refMap[bookEn] || bookEn);
        }

        /* ==========================================================
        è¨€èªã®è‡ªå‹•åˆ¤å®šï¼ˆåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ï¼‰
        - ä»¥å‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§é¸ã‚“ã è¨€èªãŒã‚ã‚Œã°ã€ãã‚Œã‚’å„ªå…ˆã™ã‚‹
        - ãã‚ŒãŒç„¡ã‘ã‚Œã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨€èªè¨­å®šã‚’è¦‹ã¦åˆ¤å®šã™ã‚‹
        - jaï¼ˆæ—¥æœ¬èªï¼‰ãªã‚‰ 'ja'
        - ãã‚Œä»¥å¤–ã¯å…¨éƒ¨ 'en'
        ========================================================== */
        function detectLanguage() {
            const savedLang =
                localStorage.getItem('arq_lang') ||
                localStorage.getItem('lang') ||
                localStorage.getItem('language') ||
                localStorage.getItem('btlq_lang');

            if (savedLang) { currentLang = savedLang; return; }

            const browserLang = navigator.language || navigator.userLanguage || '';
            currentLang = browserLang.toLowerCase().startsWith('ja') ? 'ja' : 'en';
        }

        function toggleLang() {
            /* JA â‡„ EN ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ */
            currentLang = currentLang === 'ja' ? 'en' : 'ja';
            document.documentElement.lang = currentLang;
            /* æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚‚åŒã˜è¨€èªã§é–‹ããŸã‚ã«ä¿å­˜ã™ã‚‹ */
            localStorage.setItem('lang', currentLang);
            /* ãƒœã‚¿ãƒ³è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆä»ŠãŒæ—¥æœ¬èªãªã‚‰ "JA"ã€è‹±èªãªã‚‰ "EN"ï¼‰ */
            document.getElementById('langBtn').innerText =
                currentLang === 'ja' ? 'EN' : 'JA';
            /* data-ja / data-en ã‚’æŒã¤è¦ç´ ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã¦å·®ã—æ›¿ãˆã‚‹ */
            document.querySelectorAll('[data-ja]').forEach(el => {
                el.innerText = el.getAttribute('data-' + currentLang);
            });

            /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚‚ä»Šã®è¨€èªã§æ›´æ–°ã™ã‚‹ */
            updateCardTexts();
            /* å¹´ä»£ã®ã‚»ãƒ¬ã‚¯ãƒˆãªã©ã€è¨€èªä¾å­˜ã®è¡¨ç¤ºã‚’å†æ§‹ç¯‰ã™ã‚‹ */
            initPickers();
            /* çµæœç”»é¢ï¼ˆæ­£è§£/æ®‹å¿µ/ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰ã‚’ç¾åœ¨è¨€èªã§å†æç”» */
            updateResultTexts();
            /* ãƒ’ãƒ³ãƒˆè¡¨ç¤ºä¸­ãªã‚‰ã€ãƒ’ãƒ³ãƒˆæ–‡ç« ã‚’ç¾åœ¨è¨€èªã§å†æç”» */
            updateHintTexts();
        }

        function updateCardTexts() {
            document.querySelectorAll('.event-card').forEach(card => {
                const data = EVENTS.find(e => e.id == card.dataset.id);
                if (data) card.querySelector('.event-name').innerText = data[currentLang];
            });
        }

        function initPickers() {
            const s = document.getElementById('select-start'), e = document.getElementById('select-end');
            const sOld = s.value, eOld = e.value;
            s.innerHTML = ''; e.innerHTML = '';
            const years = [...new Set(EVENTS.map(ev => ev.year))].sort((a, b) => a - b);
            years.forEach(y => {
                let label = currentLang === 'ja' ? (y < 0 ? `å‰ ${Math.abs(y)}å¹´` : `è¥¿æš¦ ${y}å¹´`) : (y < 0 ? `BCE ${Math.abs(y)}` : `CE ${y}`);
                s.add(new Option(label, y)); e.add(new Option(label, y));
            });
            if (sOld) s.value = sOld; if (eOld) e.value = eOld;
        }

        function quickSet(sVal, eVal, btn) {
            document.getElementById('select-start').value = sVal;
            document.getElementById('select-end').value = eVal;
            document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('error-msg').innerText = "";
        }

        function startGame() {
            const s = parseInt(document.getElementById('select-start').value);
            const e = parseInt(document.getElementById('select-end').value);
            const count = parseInt(document.getElementById('count-select').value);
            let filtered = EVENTS.filter(ev => ev.year >= s && ev.year <= e);
            if (filtered.length < count) {
                const msg = currentLang === 'ja' ? `ã‚¤ãƒ™ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆç¾åœ¨${filtered.length}å€‹ï¼‰` : `Not enough events (Only ${filtered.length} available)`;
                document.getElementById('error-msg').innerText = msg;
                return;
            }
            document.getElementById('error-msg').innerText = "";
            currentTask = filtered.sort(() => 0.5 - Math.random()).slice(0, count);

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯è¨­å®š
            const isTimeAttack = document.getElementById('time-attack-select').value === 'on';
            clearInterval(timerInterval);

            if (isTimeAttack) {
                document.getElementById('timer-display').classList.remove('hidden');
                timeLeft = count * 12;
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            } else {
                document.getElementById('timer-display').classList.add('hidden');
            }

            renderGame(true);
            switchScreen('screen-game');
        }

        function updateTimerDisplay() {
            document.getElementById('time-left').innerText = timeLeft;
        }

        function renderGame(shuffle) {
            const list = document.getElementById('event-list');
            list.innerHTML = '';

            let displayList = [...currentTask];
            if (shuffle) displayList.sort(() => 0.5 - Math.random());

            // âœ… å¿µã®ãŸã‚ï¼šå‰å›ã®PCãƒ‰ãƒ©ãƒƒã‚°ãŒä¸­é€”åŠç«¯ã«æ®‹ã£ã¦ãŸã‚‰æƒé™¤
            draggingItemPC = null;
            if (pcPlaceholder && pcPlaceholder.parentNode) pcPlaceholder.remove();
            pcPlaceholder = null;

            displayList.forEach(item => {
                const el = document.createElement('div');
                el.className = 'event-card';
                el.dataset.id = item.id;

                el.innerHTML =
                    `<span class="material-icons drag-handle" style="color:#ccc">drag_indicator</span>` +
                    `<div class="event-name" style="flex:1">${item[currentLang]}</div>`;

                /* ===== PCãƒ‰ãƒ©ãƒƒã‚° ===== */
                el.draggable = true;

                el.addEventListener('dragstart', (e) => {
                    draggingItemPC = el;
                    el.classList.add('dragging');

                    // âœ… placeholder ã‚’ã€Œç½®æ›ã€ã§ã¯ãªãã€ŒæŒ¿å…¥ã€ã™ã‚‹ï¼ˆDOMã‹ã‚‰å¤–ã•ãªã„ï¼‰
                    const rect = el.getBoundingClientRect();
                    pcPlaceholder = document.createElement('div');
                    pcPlaceholder.className = 'sortable-placeholder';
                    pcPlaceholder.style.height = rect.height + 'px';

                    // å…ƒã‚«ãƒ¼ãƒ‰ã®ç›´å¾Œã«å…¥ã‚Œã‚‹ï¼ˆå…ƒã‚«ãƒ¼ãƒ‰ã®å ´æ‰€ã‚’ç¢ºä¿ï¼‰
                    el.parentNode.insertBefore(pcPlaceholder, el.nextSibling);

                    // âœ… dragé–‹å§‹ãŒæˆç«‹ã—ã¦ã‹ã‚‰å…ƒã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆã™ï¼ˆChromeå‘ã‘ã®å®šç•ªï¼‰
                    setTimeout(() => {
                        if (draggingItemPC === el) el.style.display = 'none';
                    }, 0);

                    if (e.dataTransfer) {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', 'x'); // ç©ºã ã¨ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„äº‹ãŒã‚ã‚‹
                    }
                });

                // âœ… drop ãŒæ¥ãªãã¦ã‚‚ dragend ã§å¿…ãšå¾©å¸°ã•ã›ã‚‹
                el.addEventListener('dragend', () => {
                    if (!draggingItemPC) return;

                    // display:none ã‚’æˆ»ã™
                    draggingItemPC.style.display = '';
                    draggingItemPC.classList.remove('dragging');

                    // placeholder ãŒæ®‹ã£ã¦ãŸã‚‰æ¶ˆã™
                    if (pcPlaceholder && pcPlaceholder.parentNode) pcPlaceholder.remove();

                    pcPlaceholder = null;
                    draggingItemPC = null;
                });

                /* ===== ã‚¹ãƒãƒ› ===== */
                el.ontouchstart = handleTouchStart;
                el.ontouchmove = handleTouchMove;
                el.ontouchend = handleTouchEnd;
                el.ontouchcancel = handleTouchEnd;

                list.appendChild(el);
            });

            /* PC: placeholder ã®ç§»å‹•ï¼ˆãƒã‚¦ã‚¹ä½ç½®ã«åˆã‚ã›ã¦æ ã ã‘å‹•ã‹ã™ï¼‰ */
            list.ondragover = (e) => {
                e.preventDefault();
                if (!pcPlaceholder) return;

                const after = getDragAfterElement(list, e.clientY);

                if (after == null) list.appendChild(pcPlaceholder);
                else list.insertBefore(pcPlaceholder, after);
            };

            /* PC: drop ã§ç¢ºå®šï¼ˆplaceholder ã®ä½ç½®ã«ã‚«ãƒ¼ãƒ‰ã‚’æˆ»ã™ï¼‰ */
            list.ondrop = (e) => {
                e.preventDefault();
                if (!draggingItemPC || !pcPlaceholder) return;

                // placeholder ã®ä½ç½®ã«ãƒ‰ãƒ©ãƒƒã‚°å…ƒã‚«ãƒ¼ãƒ‰ã‚’æˆ»ã™
                list.insertBefore(draggingItemPC, pcPlaceholder);

                // å¾©å¸°
                draggingItemPC.style.display = '';
                draggingItemPC.classList.remove('dragging');

                // æƒé™¤
                pcPlaceholder.remove();
                pcPlaceholder = null;
                draggingItemPC = null;
            };
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.event-card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        let activeItem = null;
        let placeholder = null;

        /* é•·æŠ¼ã—ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰ */
        let pressTimer = null;
        let isDragging = false;

        let preMoveListener = null;

        let draggingItemPC = null;
        let pcPlaceholder = null;

        function attachPreMoveCancel() {
            if (preMoveListener) return;

            preMoveListener = (ev) => {
                if (!pressTimer || isDragging) return;

                const t = ev.touches[0];
                const dx = t.clientX - startX;
                const dy = t.clientY - startY;
                const dist = Math.hypot(dx, dy);

                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ã¤ã‚‚ã‚Š â†’ é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (dist > CANCEL_MOVE_THRESHOLD) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                    detachPreMoveCancel();
                }
            };

            // â˜…ã“ã“ã¯ passive:true ã§OKï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é‚ªé­”ã—ãªã„ï¼‰
            document.addEventListener('touchmove', preMoveListener, { passive: true });
        }

        function detachPreMoveCancel() {
            if (!preMoveListener) return;
            document.removeEventListener('touchmove', preMoveListener);
            preMoveListener = null;
        }

        /* ã‚¿ãƒƒãƒé–‹å§‹ä½ç½®ï¼ˆé•·æŠ¼ã—æˆç«‹å‰ã®ç§»å‹•åˆ¤å®šç”¨ï¼‰ */
        let startX = 0;
        let startY = 0;

        /* å¥½ã¿ã§èª¿æ•´OK */
        const LONG_PRESS_MS = 200;          // é•·æŠ¼ã—æ™‚é–“
        const CANCEL_MOVE_THRESHOLD = 10;   // ã“ã‚Œä»¥ä¸Šå‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆpxï¼‰

        /* æŒ‡ã®ä½ç½®ã¨ã‚«ãƒ¼ãƒ‰å·¦ä¸Šã®å·®åˆ†ï¼ˆè¿½å¾“ç”¨ï¼‰ */
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        /* è¿½å¾“ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ãŸã‚ã® rAF åˆ¶å¾¡ */
        let rafId = null;
        let pendingX = 0;
        let pendingY = 0;

        /* ===== è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆãƒ‰ãƒ©ãƒƒã‚°ç«¯ï¼‰ ===== */
        const AUTO_SCROLL_ZONE = 80;   // ç”»é¢ç«¯ã‹ã‚‰ä½•pxã§ç™ºå‹•
        const AUTO_SCROLL_MAX = 14;    // æœ€å¤§é€Ÿåº¦ï¼ˆpx/frameï¼‰

        let autoScrollDir = 0;         // -1:ä¸Š, 0:åœæ­¢, +1:ä¸‹
        let autoScrollRaf = null;

        /* ç«¯ã«è¿‘ã„ã»ã©é€Ÿãã™ã‚‹ï¼ˆç·šå½¢ã§ååˆ†ï¼‰ */
        function calcAutoScrollSpeed(clientY) {
            if (clientY < AUTO_SCROLL_ZONE) {
                const t = (AUTO_SCROLL_ZONE - clientY) / AUTO_SCROLL_ZONE; // 0..1
                return Math.ceil(AUTO_SCROLL_MAX * t);
            }
            if (clientY > window.innerHeight - AUTO_SCROLL_ZONE) {
                const d = clientY - (window.innerHeight - AUTO_SCROLL_ZONE);
                const t = d / AUTO_SCROLL_ZONE; // 0..1
                return Math.ceil(AUTO_SCROLL_MAX * t);
            }
            return 0;
        }

        function setAutoScrollByPointer(clientY) {
            if (clientY < AUTO_SCROLL_ZONE) autoScrollDir = -1;
            else if (clientY > window.innerHeight - AUTO_SCROLL_ZONE) autoScrollDir = 1;
            else autoScrollDir = 0;

            if (autoScrollDir !== 0) startAutoScrollLoop();
            else stopAutoScrollLoop();
        }

        function startAutoScrollLoop() {
            if (autoScrollRaf) return;

            const tick = () => {
                autoScrollRaf = null;

                // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã ã‘å›ã™
                if (!isDragging) return;

                const speed = calcAutoScrollSpeed(pendingY);

                if (autoScrollDir !== 0 && speed > 0) {
                    window.scrollBy(0, autoScrollDir * speed);

                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã¶ã‚“ã‚‚å«ã‚ã¦ã€ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚«ãƒ¼ãƒ‰ã‚’è¿½å¾“æ›´æ–°
                    moveDraggedItem(pendingX, pendingY);

                    // placeholder åˆ¤å®šã‚‚ã€Œæœ€å¾Œã®æŒ‡ä½ç½®ã€ã§æ›´æ–°ã—ç¶šã‘ã‚‹
                    updatePlaceholderByPointer(pendingX, pendingY);
                }

                // ç«¯ã«ã„ã‚‹é™ã‚Šå›ã—ç¶šã‘ã‚‹ï¼ˆæ­¢ã‚ã‚‹ã®ã¯ stopAutoScrollLoopï¼‰
                if (autoScrollDir !== 0) {
                    autoScrollRaf = requestAnimationFrame(tick);
                }
            };

            autoScrollRaf = requestAnimationFrame(tick);
        }

        function stopAutoScrollLoop() {
            autoScrollDir = 0;
            if (autoScrollRaf) {
                cancelAnimationFrame(autoScrollRaf);
                autoScrollRaf = null;
            }
        }

        /* placeholderç§»å‹•ãƒ­ã‚¸ãƒƒã‚¯ã‚’é–¢æ•°åŒ–ï¼ˆhandleTouchMoveå†…ã®å¾ŒåŠã‚’ç§»æ¤ï¼‰ */
        function updatePlaceholderByPointer(x, y) {
            if (!placeholder) return;

            // â˜…ä¿é™ºï¼šè‡ªåˆ†ã‚’ä¸€ç¬éš ã—ã¦ä¸‹ã®è¦ç´ ã‚’æ­£ã—ãæ‹¾ã†
            const prevVis = activeItem?.style.visibility;
            if (activeItem) activeItem.style.visibility = 'hidden';

            const target = document.elementFromPoint(x, y);

            if (activeItem) activeItem.style.visibility = prevVis || '';

            const card = target ? target.closest('.event-card') : null;
            if (!card || card === activeItem || card === placeholder) return;

            const rect = card.getBoundingClientRect();
            if (y < rect.top + rect.height / 2) card.before(placeholder);
            else card.after(placeholder);
        }

        function handleTouchStart(e) {
            // ã“ã“ã§ã¯ã¾ã ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã—ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å„ªå…ˆï¼‰
            isDragging = false;

            // ã‚«ãƒ¼ãƒ‰ã‚’æ´ã‚“ã æ‰±ã„ã«ã™ã‚‹
            activeItem = this;
            if (!activeItem) return;

            // åˆæœŸã‚¿ãƒƒãƒä½ç½®ï¼ˆå‹•ã„ãŸã‚‰é•·æŠ¼ã—ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ãŸã‚ï¼‰
            const touch = e.touches[0];
            startX = touch.clientX;
            startY = touch.clientY;
            attachPreMoveCancel();

            document.addEventListener(
                'touchend',
                () => {
                    if (!isDragging && pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                },
                { passive: true, once: true }
            );

            document.addEventListener(
                'touchcancel',
                () => {
                    if (!isDragging && pressTimer) {
                        clearTimeout(pressTimer);
                        pressTimer = null;
                    }
                },
                { passive: true, once: true }
            );

            // æ—¢å­˜ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            // é•·æŠ¼ã—æˆç«‹ã—ãŸã‚‰ã€Œã“ã“ã§åˆã‚ã¦ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã€
            pressTimer = setTimeout(() => {
                // â˜…ã“ã“ã«æ¥ãŸæ™‚ç‚¹ã§ã€æŒ‡ãŒé›¢ã‚Œã¦ã„ãŸã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¦ã„ã‚‹ã¯ãšã ãŒå¿µã®ãŸã‚
                if (isDragging) return;
                if (!activeItem) return;

                // ã“ã“ã§ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
                isDragging = true;
                // â˜… ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ¤œçŸ¥ã¯ã‚‚ã†ä¸è¦
                detachPreMoveCancel();
                activeItem.classList.add('dragging');

                /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æŒ‡ã®å‹•ãã‚’å–ã‚Šã“ã¼ã•ãªã„ãŸã‚ */
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                document.addEventListener('touchend', handleTouchEnd, { passive: false });
                document.addEventListener('touchcancel', handleTouchEnd, { passive: false });

                /* è¿½å¾“ç”¨ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆè¨ˆç®—ï¼ˆã‚«ãƒ¼ãƒ‰å·¦ä¸Šã¨ã®å·®åˆ†ï¼‰ */
                const rect = activeItem.getBoundingClientRect();
                dragOffsetX = startX - rect.left;
                dragOffsetY = startY - rect.top;

                /* placeholder ã‚’ç”¨æ„ï¼ˆç„¡ã‘ã‚Œã°ä½œã‚‹ï¼‰ */
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'sortable-placeholder';
                }
                placeholder.style.height = rect.height + "px";

                // å…ƒã®å ´æ‰€ã‚’ placeholder ã«ç½®ãæ›ãˆã‚‹ï¼ˆâ†ã“ã‚Œã¯å¿…è¦ï¼‰
                activeItem.replaceWith(placeholder);

                // â˜…ã‚«ãƒ¼ãƒ‰ã¯ãƒªã‚¹ãƒˆã«æˆ»ã•ãšã€body ã«é€€é¿ã•ã›ã‚‹
                document.body.appendChild(activeItem);


                /* è¦‹ãŸç›®ï¼šãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚¹ã‚¿ã‚¤ãƒ« */
                activeItem.style.width = rect.width + "px";
                activeItem.style.height = rect.height + "px";
                activeItem.style.position = "fixed";
                activeItem.style.zIndex = "9999";
                activeItem.style.pointerEvents = "none";
                activeItem.style.opacity = "0.9";
                activeItem.style.margin = "0";              // â˜…ã‚ºãƒ¬é˜²æ­¢
                activeItem.style.boxSizing = "border-box";  // â˜…å¿µã®ãŸã‚
                activeItem.style.left = rect.left + "px";   // â˜…åˆæœŸä½ç½®å›ºå®š
                activeItem.style.top = rect.top + "px";

                /* æœ€åˆã®ä½ç½®æ›´æ–°ï¼ˆæŒ‡ã«è¿½å¾“ï¼‰ */
                moveDraggedItem(startX, startY);

                // ã‚¿ã‚¤ãƒãƒ¼ã‚’ä½¿ã„æ¨ã¦ã«ã™ã‚‹
                pressTimer = null;
            }, LONG_PRESS_MS);
        }

        function moveDraggedItem(clientX, clientY) {
            // æŒ‡ã®ä½ç½®ï¼ˆpendingï¼‰ã‚’æ›´æ–°
            pendingX = clientX;
            pendingY = clientY;

            // ã™ã§ã« rAF ãŒå›ã£ã¦ã‚‹ãªã‚‰äºˆç´„ã ã‘æ›´æ–°ã—ã¦çµ‚ã‚ã‚Š
            if (rafId) return;

            rafId = requestAnimationFrame(() => {
                rafId = null;
                if (!activeItem) return;

                const left = pendingX - dragOffsetX;
                const top = pendingY - dragOffsetY;

                activeItem.style.left = left + "px";
                activeItem.style.top = top + "px";
            });
        }

        function handleTouchMove(e) {
            if (!activeItem) return;

            const touch = e.touches[0];
            const x = touch.clientX;
            const y = touch.clientY;

            if (!isDragging) return; // é•·æŠ¼ã—æˆç«‹å‰ã¯ä½•ã‚‚ã—ãªã„

            e.preventDefault();
            // è¿½å¾“ï¼ˆpendingX/pendingYãŒæ›´æ–°ã•ã‚Œã‚‹ï¼‰
            moveDraggedItem(x, y);
            // â˜… è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¤å®šï¼ˆç«¯ãªã‚‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é–‹å§‹ï¼‰
            setAutoScrollByPointer(y);
            // placeholder æ›´æ–°ï¼ˆé€šå¸¸ï¼‰
            updatePlaceholderByPointer(x, y);
        }


        function handleTouchEnd() {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }

            // â˜…è¿½åŠ ï¼šè‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœæ­¢
            stopAutoScrollLoop();

            if (!isDragging) {
                detachPreMoveCancel();
                activeItem = null;
                return;
            }

            isDragging = false;

            if (!activeItem) return;

            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }

            const list = document.getElementById('event-list');

            if (placeholder && list && list.contains(placeholder)) {
                placeholder.replaceWith(activeItem);
                placeholder = null;
            } else if (list && activeItem) {
                list.appendChild(activeItem);
            }

            activeItem.classList.remove('dragging');

            activeItem.style.position = '';
            activeItem.style.left = '';
            activeItem.style.top = '';
            activeItem.style.right = '';
            activeItem.style.bottom = '';
            activeItem.style.width = '';
            activeItem.style.height = '';
            activeItem.style.zIndex = '';
            activeItem.style.pointerEvents = '';
            activeItem.style.margin = '';
            activeItem.style.transform = '';
            activeItem.style.opacity = '1';

            activeItem = null;

            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
            document.removeEventListener('touchcancel', handleTouchEnd);
        }

        // âœ… å…±é€šï¼šæ­£è§£é †ã‚½ãƒ¼ãƒˆï¼ˆå¹´â†’æœˆâ†’æ—¥â†’idï¼‰
        function sortEventsChrono(a, b) {
            return (a.year - b.year) ||
                ((a.month ?? 1) - (b.month ?? 1)) ||
                ((a.day ?? 1) - (b.day ?? 1)) ||
                (a.id - b.id);
        }

        // âœ… å…±é€šï¼šcurrentTask ã‹ã‚‰æ­£è§£IDé…åˆ—ã‚’ä½œã‚‹
        function getCorrectIds() {
            if (!Array.isArray(currentTask) || currentTask.length === 0) return [];
            return [...currentTask].sort(sortEventsChrono).map(e => e.id);
        }

        // âœ… å…±é€šï¼šç”»é¢ä¸Šã®ä¸¦ã³ï¼ˆIDé…åˆ—ï¼‰
        function getUserIds() {
            return [...document.querySelectorAll('.event-card')]
                .map(el => parseInt(el.dataset.id, 10))
                .filter(n => Number.isFinite(n));
        }

        // âœ… å…±é€šï¼šé…åˆ—ä¸€è‡´ï¼ˆJSON stringifyã‚ˆã‚Šå®‰å…¨ï¼‰
        function arraysEqual(a, b) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) if (a[i] !== b[i]) return false;
            return true;
        }

        function checkOrder() {
            clearInterval(timerInterval);

            const userIds = getUserIds();
            const correctIds = getCorrectIds();

            const isWin = (userIds.length > 0) && arraysEqual(userIds, correctIds);

            if (isWin) {
                const fire = (typeof confetti === 'function') ? confetti : (window.confetti || null);
                if (fire) {
                    fire({ particleCount: 150, spread: 70, origin: { x: 0.5, y: 0.5 } });
                }
            }

            showResultScreen(isWin);
        }

        /* ==========================================================
        çµæœç”»é¢ã®æ–‡è¨€ã‚’ currentLang ã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹
        - toggleLang() ã‹ã‚‰ã‚‚å‘¼ã°ã‚Œã‚‹
        - å‹æ•—ï¼ˆlastIsWinï¼‰ã‚’å…ƒã«è¡¨ç¤ºã‚’æ±ºã‚ã‚‹
        ========================================================== */
        function updateResultTexts() {
            if (lastIsWin === null) return;
            document.getElementById('result-title').innerText = lastIsWin
                ? (currentLang === 'ja' ? "æ­£è§£ï¼" : "Correct!")
                : (currentLang === 'ja' ? "æ®‹å¿µ" : "Oops");
        }

        /* ==========================================================
        ãƒ’ãƒ³ãƒˆè¡¨ç¤ºã®æ–‡è¨€ã‚’ currentLang ã«åˆã‚ã›ã¦æ›´æ–°ã™ã‚‹
        - toggleLang() ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
        - ç›´å‰ã«è¡¨ç¤ºã—ãŸãƒ’ãƒ³ãƒˆã®å†…å®¹ï¼ˆlastHintIds / lastHintWasEmptyï¼‰ã‚’å…ƒã«å†æ§‹ç¯‰ã™ã‚‹
        - ãƒ’ãƒ³ãƒˆãŒè¡¨ç¤ºä¸­ã§ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        ========================================================== */
        function updateHintTexts() {

            /* ãƒ’ãƒ³ãƒˆé ˜åŸŸãŒå­˜åœ¨ã—ãªã„ãƒšãƒ¼ã‚¸ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            const hintArea = document.getElementById('hint-area');
            if (!hintArea) return;

            /* ãƒ’ãƒ³ãƒˆãŒãã‚‚ãã‚‚è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼ˆhiddenï¼‰ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            if (hintArea.classList.contains('hidden')) return;

            /* showHint() ãŒã¾ã ä¸€åº¦ã‚‚å‘¼ã°ã‚Œã¦ã„ãªã„ãªã‚‰ä½•ã‚‚ã—ãªã„ */
            if (lastHintIds === null && lastHintWasEmpty === null) return;

            /* ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆè¦‹å‡ºã—ï¼‰ */
            const title = currentLang === 'ja'
                ? "ğŸ’¡ èª¿æŸ»ã®åŠ©ã‘:"
                : "ğŸ’¡ Clues for misplaced items:";

            let html = `<strong>${title}</strong><br><br>`;

            /* ã€Œä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã€ã‚±ãƒ¼ã‚¹ */
            if (lastHintWasEmpty) {
                html += currentLang === 'ja'
                    ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚"
                    : "The order seems correct.";

                hintArea.innerHTML = html;
                return;
            }

            /* é€šå¸¸ã‚±ãƒ¼ã‚¹ï¼šlastHintIds ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼•ã„ã¦å†æ§‹ç¯‰ */
            const hints = (lastHintIds || [])
                .map(id => EVENTS.find(e => e.id === id))
                .filter(Boolean);

            /* å¿µã®ãŸã‚ï¼šå¾©å…ƒã§ããªã‹ã£ãŸã‚‰ç©ºæ‰±ã„ã«ã™ã‚‹ */
            if (hints.length === 0) {
                html += currentLang === 'ja'
                    ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚"
                    : "The order seems correct.";

                hintArea.innerHTML = html;
                return;
            }

            hints.forEach(s => {
                const hintDesc = s['hint_' + currentLang] || "";
                html += `<div class="hint-item">
                    ãƒ»${s[currentLang]} (${formatRef(s.ref)})
                    <span class="hint-desc">${hintDesc}</span>
                 </div>`;
            });

            hintArea.innerHTML = html;
        }

        function showResultScreen(isWin) {

            /* ç›´å‰ã®å‹æ•—ã‚’ä¿å­˜ï¼ˆè¨€èªåˆ‡æ›¿æ™‚ã«å†æç”»ã™ã‚‹ãŸã‚ï¼‰ */
            lastIsWin = isWin;

            switchScreen('screen-result');
            const difficulty = parseInt(
                document.getElementById('count-select').value
            );

            /* ã‚¢ã‚¤ã‚³ãƒ³ã ã‘ã¯ã“ã“ã§æ±ºå®šã—ã¦OK */
            document.getElementById('result-icon').innerText =
                isWin ? "celebration" : "book";

            document.getElementById('fail-options').className = isWin ? "hidden" : "";
            document.getElementById('success-options').className = isWin ? "" : "hidden";

            /* â˜… çµæœã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…ãšã“ã“ã§ä¸€æ‹¬æ›´æ–° */
            updateResultTexts();
        }

        function showHint() {
            const hintArea = document.getElementById('hint-area');
            if (!hintArea) return;

            const userIds = getUserIds();
            const correctIds = getCorrectIds();

            // ã¾ã ã‚²ãƒ¼ãƒ ãŒæˆç«‹ã—ã¦ãªã„ä¿é™º
            if (userIds.length === 0 || correctIds.length === 0) {
                lastHintIds = [];
                lastHintWasEmpty = true;
                hintArea.innerHTML =
                    `<strong>${currentLang === 'ja' ? "ğŸ’¡ èª¿æŸ»ã®åŠ©ã‘:" : "ğŸ’¡ Clues:"}</strong><br><br>` +
                    (currentLang === 'ja' ? "ã¾ã ä¸¦ã³æ›¿ãˆå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚" : "No items to check yet.");
                hintArea.classList.remove('hidden');
                switchScreen('screen-game');
                return;
            }

            // id â†’ æ­£ã—ã„ä½ç½®
            const posMap = {};
            correctIds.forEach((id, idx) => posMap[id] = idx);

            // ç•°å¸¸ç³»ï¼ˆé‡è¤‡ãƒ»æ¬ è½ãƒ»å¤–éƒ¨IDï¼‰
            const userSet = new Set(userIds);
            const correctSet = new Set(correctIds);
            const hasDuplicate = userSet.size !== userIds.length;
            const hasOutOfTask = userIds.some(id => !correctSet.has(id));
            const hasMissing = correctIds.some(id => !userSet.has(id));

            // æœ€åˆã®ã€Œé€†è»¢ã—ã¦ã„ã‚‹éš£æ¥ãƒšã‚¢ã€ã‚’æ¢ã™
            let conflictPairIds = null;
            for (let i = 0; i < userIds.length - 1; i++) {
                const a = userIds[i];
                const b = userIds[i + 1];
                const pa = posMap[a];
                const pb = posMap[b];
                if (pa == null || pb == null) continue; // taskå¤–ã¯ä¿é™ºã§ç„¡è¦–
                if (pa > pb) { conflictPairIds = [a, b]; break; }
            }

            // ãƒ’ãƒ³ãƒˆå¯¾è±¡ï¼ˆæœ€å¤§2ï¼‰
            const hintsToShow = conflictPairIds
                ? conflictPairIds.map(id => EVENTS.find(e => e.id === id)).filter(Boolean)
                : [];

            // è¨€èªåˆ‡æ›¿ã®å†æç”»ç”¨ã«ä¿å­˜
            lastHintIds = hintsToShow.map(e => e.id);
            lastHintWasEmpty = (hintsToShow.length === 0) && !(hasDuplicate || hasOutOfTask || hasMissing);

            const title = currentLang === 'ja'
                ? "ğŸ’¡ èª¿æŸ»ã®åŠ©ã‘:"
                : "ğŸ’¡ Clues for misplaced items:";

            let html = `<strong>${title}</strong><br><br>`;

            // ã¾ãšã¯ã‚»ãƒƒãƒˆç•°å¸¸ã‚’å„ªå…ˆè¡¨ç¤º
            if (hasDuplicate || hasOutOfTask || hasMissing) {
                if (currentLang === 'ja') {
                    html += "ä¸¦ã³ã®å†…å®¹ã«å•é¡ŒãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚<br>";
                    if (hasDuplicate) html += "ãƒ»åŒã˜ã‚«ãƒ¼ãƒ‰ãŒé‡è¤‡ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>";
                    if (hasOutOfTask) html += "ãƒ»èª²é¡Œã«å«ã¾ã‚Œãªã„ã‚«ãƒ¼ãƒ‰ãŒæ··ã–ã£ã¦ã„ã¾ã™ã€‚<br>";
                    if (hasMissing) html += "ãƒ»èª²é¡Œã«å¿…è¦ãªã‚«ãƒ¼ãƒ‰ãŒæ¬ ã‘ã¦ã„ã¾ã™ã€‚<br>";
                    html += "<br>ã¾ãšã¯ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡ã¨æšæ•°ã‚’æ•´ãˆã¦ãã ã•ã„ã€‚";
                } else {
                    html += "There seems to be a problem with the set of items.<br>";
                    if (hasDuplicate) html += "â€¢ Some items may be duplicated.<br>";
                    if (hasOutOfTask) html += "â€¢ An item not in this task is included.<br>";
                    if (hasMissing) html += "â€¢ A required item is missing.<br>";
                    html += "<br>Please fix the set of cards first.";
                }
            } else if (hintsToShow.length === 0) {
                // ã‚»ãƒƒãƒˆæ­£å¸¸ï¼†é€†è»¢ãªã— â†’ ä¸¦ã³é †OKï¼ˆå°‘ãªãã¨ã‚‚ã€Œé€†è»¢ã€ã¯ãªã„ï¼‰
                html += currentLang === 'ja'
                    ? "ä¸¦ã³é †ã¯åˆã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚"
                    : "The order seems correct.";
            } else {
                // é€†è»¢ãƒšã‚¢ã®æ¯”è¼ƒãƒ’ãƒ³ãƒˆï¼ˆã‚ãªãŸã®æ„å›³ã©ãŠã‚Šï¼‰
                for (const ev of hintsToShow) {
                    const name = ev[currentLang] || ev.ja || "";
                    const hintDesc = ev['hint_' + currentLang] || ev.hint_ja || "";
                    html += `<div class="hint-item">ãƒ»${name} (${formatRef(ev.ref)})`;
                    if (hintDesc) html += `<span class="hint-desc">${hintDesc}</span>`;
                    html += `</div>`;
                }
            }

            hintArea.innerHTML = html;
            hintArea.classList.remove('hidden');
            switchScreen('screen-game');

            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ONã®å ´åˆã®ã¿ã‚¿ã‚¤ãƒãƒ¼å†å§‹å‹•ï¼ˆtimeLeftã¯ç¶­æŒï¼‰
            const isTimeAttack = document.getElementById('time-attack-select')?.value === 'on';
            if (isTimeAttack) {
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            }
        }

        function retryThisTask() {
            document.getElementById('hint-area').classList.add('hidden');
            renderGame(false);
            switchScreen('screen-game');

            const isTimeAttack = document.getElementById('time-attack-select').value === 'on';
            if (isTimeAttack) {
                const count = parseInt(document.getElementById('count-select').value);
                timeLeft = count * 15;
                updateTimerDisplay();
                clearInterval(timerInterval);
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        alert(currentLang === 'ja' ? "æ™‚é–“åˆ‡ã‚Œï¼" : "Time's Up!");
                        checkOrder();
                    }
                }, 1000);
            }
        }

        function switchScreen(id) {
            document.getElementById('screen-setup').classList.add('hidden');
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-result').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        /* ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç¬é–“ã«ã‚„ã‚‹ã“ã¨ï¼ˆåˆæœŸåŒ–ï¼‰ */
        window.onload = () => {

            /* 1) ãƒ–ãƒ©ã‚¦ã‚¶è¨€èª or ä¿å­˜æ¸ˆã¿è¨€èªã‚’è¦‹ã¦ currentLang ã‚’æ±ºã‚ã‚‹ */
            detectLanguage();
            document.documentElement.lang = currentLang;

            /* 2) è¨€èªãƒœã‚¿ãƒ³ï¼ˆJA/ENï¼‰ã®è¡¨ç¤ºã‚’ currentLang ã«åˆã‚ã›ã‚‹ */
            const langBtn = document.getElementById('langBtn');
            if (langBtn) {
                langBtn.innerText = currentLang === 'ja' ? 'EN' : 'JA';
            }

            /* 3) data-ja / data-en ã®æ–‡è¨€ã‚’ currentLang ã®è¨€èªã«åˆ‡ã‚Šæ›¿ãˆã‚‹
                  â€» ã“ã‚Œã‚’ã‚„ã‚‰ãªã„ã¨ã€HTMLã«ç›´æ›¸ãã•ã‚ŒãŸåˆæœŸè¡¨ç¤ºã®ã¾ã¾ã«ãªã‚‹ */
            document.querySelectorAll('[data-ja]').forEach(el => {
                el.innerText = el.getAttribute('data-' + currentLang);
            });

            /* 4) å¹´ä»£ã‚»ãƒ¬ã‚¯ãƒˆç­‰ã‚’ currentLang ã§æç”»ã™ã‚‹ï¼ˆBCE/CEè¡¨ç¤ºã‚‚å«ã‚€ï¼‰ */
            initPickers();

            /* 5) åˆæœŸã®é–‹å§‹/çµ‚äº†ã‚’ã‚»ãƒƒãƒˆï¼ˆselect ãŒå­˜åœ¨ã™ã‚‹ãƒšãƒ¼ã‚¸ã ã‘ï¼‰ */
            const startSel = document.getElementById('select-start');
            const endSel = document.getElementById('select-end');
            if (startSel && endSel) {
                startSel.value = -4026;
                endSel.value = 98;
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            // --- HOME ---
            const homeBtn = document.getElementById('homeBtn');
            if (homeBtn) {
                homeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // GitHub Pagesã® /btlq/ ã«æˆ»ã™ãªã‚‰ã“ã£ã¡æ¨å¥¨
                    location.href = '/btlq/';
                    // ãƒ«ãƒ¼ãƒˆï¼ˆ arqgames.github.io/ ï¼‰ã«æˆ»ã—ãŸã„ãªã‚‰ '/' ã®ã¾ã¾ã§OK
                    // location.href = '/';
                });
            }

            // --- LANGï¼ˆç¢ºå®Ÿç‰ˆï¼‰---
            const langBtn0 = document.getElementById('langBtn');
            if (langBtn0) {
                const langBtn = langBtn0.cloneNode(true);
                langBtn0.parentNode.replaceChild(langBtn, langBtn0);

                langBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (e.stopImmediatePropagation) e.stopImmediatePropagation();

                    if (typeof window.toggleLang === 'function') { window.toggleLang(); return; }
                    if (typeof window.toggleLanguage === 'function') { window.toggleLanguage(); return; }
                    if (typeof window.switchLanguage === 'function') { window.switchLanguage(); return; }
                    if (typeof window.setLanguage === 'function') { window.setLanguage(); return; }

                    const saved =
                        localStorage.getItem('arq_lang') ||
                        localStorage.getItem('lang') ||
                        localStorage.getItem('language') ||
                        localStorage.getItem('btlq_lang');

                    const current = saved || (navigator.language?.startsWith('ja') ? 'ja' : 'en');
                    const next = (current === 'ja') ? 'en' : 'ja';

                    localStorage.setItem('arq_lang', next);
                    localStorage.setItem('lang', next);
                    localStorage.setItem('language', next);
                    localStorage.setItem('btlq_lang', next);

                    if (typeof window.applyLang === 'function') {
                        window.applyLang(next);
                        return;
                    }
                    location.reload();
                }, true);
            }

            // ===== ã‚¤ãƒ™ãƒ³ãƒˆJSONèª­ã¿è¾¼ã¿ï¼ˆçµ±ä¸€ç‰ˆï¼‰ =====
            window.EVENTS = [];

            async function loadEvents() {
                // å…ˆé ­ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ç›´ä¸‹èµ·ç‚¹ã€ãªã®ã§ã€GitHub Pagesã§ã¯OK
                const url = "/btlq/data/events/events_all.json";

                try {
                    const res = await fetch(url, { cache: "no-store" });

                    if (!res.ok) {
                        const text = await res.text();
                        console.error("Fetch failed:", res.status, res.statusText, "url=", url);
                        console.error("Response head:", text.slice(0, 200));
                        return;
                    }

                    const data = await res.json();

                    if (!Array.isArray(data)) {
                        console.error("Invalid JSON: expected an Array, got:", typeof data, data);
                        return;
                    }

                    window.EVENTS = data;
                    console.log("EVENTS loaded:", window.EVENTS.length);

                    // initSetupScreen ãŒå­˜åœ¨ã™ã‚‹å‰æ
                    if (typeof window.initSetupScreen === "function") {
                        window.initSetupScreen();
                    } else {
                        console.warn("initSetupScreen is not defined yet.");
                    }
                } catch (e) {
                    console.error("Event load failed:", e, "url=", url);
                }
            }

            // å¤–å´ãŒ DOMContentLoaded ãªã®ã§ã€ã“ã“ã¯ç›´æ¥å‘¼ã¶ã ã‘ã§OK
            loadEvents();
        });

    </script>

    <footer style="margin-top:40px; padding:20px 0; border-top:1px solid #ddd; font-size:14px; text-align:center;">
        <a href="/about.html" target="_blank" rel="noopener noreferrer" style="margin:0 10px;">
            About
        </a>
        <a href="/privacy.html" target="_blank" rel="noopener noreferrer" style="margin:0 10px;">
            Privacy Policy
        </a>
        <a href="/contact.html" target="_blank" rel="noopener noreferrer" style="margin:0 10px;">
            Contact
        </a>
    </footer>

</body>

</html>
